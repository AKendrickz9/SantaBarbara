<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Batter vs Pitcher Scouting Reports</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
  /* global page layout */
  :root {
    --gap: 1rem;
    --card-pad: 0.5rem;
    --border: #ccc;
    --table-border: #ddd;
    --table-font: 0.75rem;
  }
  * { box-sizing: border-box; }
  body {
    font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    margin: 1rem;
  }
  #controls {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: .75rem 1rem;
    margin-bottom: 1rem;
  }
  select, button, input[type="file"] {
    padding: .35rem .5rem;
    font-size: .95rem;
  }
  button {
    cursor: pointer;
    border: 1px solid #bbb;
    background: #f6f6f6;
    border-radius: .375rem;
  }
  #status { margin-left: auto; font-size: .9rem; opacity:.75; }

  /* each “page” is a 2×2 grid of PA cards */
  .page {
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: auto auto;
    gap: var(--gap);
    page-break-after: always;
    margin-bottom: 2rem;
  }
  .blank-page {
    height: 100vh;
    page-break-after: always;
  }

  /* individual PA card */
  .pa-card {
    position: relative;       /* for stacking context */
    border: 1px solid var(--border);
    padding: var(--card-pad);
    display: flex;
    flex-direction: column;
    background: #fff;
  }
  .pa-header {
    font-weight: 600;
    margin-bottom: 0.5rem;
    font-size: 0.92rem;
    line-height: 1.25;
  }

  /* canvas wrapper */
  .pa-canvas { position: relative; z-index: 1; }

  /* the strike-zone canvas */
  canvas {
    width: 100%;
    margin-top: 30px;         /* adjust vertical spacing */
    height: 320px;            /* taller for visibility (visual size) */
    background: transparent;
    display: block;
    position: relative;
    z-index: 1;
  }

  /* detail table overlay */
  .detail {
    position: relative;
    z-index: 2;
    margin-top: 0;
    background: rgba(255,255,255,0.86);
    overflow: auto;
  }

  /* table styling */
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: var(--table-font);
    margin: 0;
  }
  th, td {
    border: 1px solid var(--table-border);
    padding: 0.2rem;
    text-align: center;
  }
  thead th { position: sticky; top: 0; background: #fafafa; }

  /* print-specific tweaks */
  @media print {
    #controls { display: none; }
    @page { size: landscape; margin: 1cm; }
    .pa-card { page-break-inside: avoid; }
    canvas { width: 100% !important; height: auto !important; }
  }
  </style>
</head>
<body>

  <div id="controls">
    <label>Batting Team:
      <select id="battingTeam"><option>Loading…</option></select>
    </label>
    <label>Pitching Team:
      <select id="pitchingTeam"><option>Loading…</option></select>
    </label>
    <button id="renderBtn">Go</button>
    <span style="margin-left:1rem;opacity:.7">or</span>
    <label style="display:inline-flex;align-items:center;gap:.5rem">
      <input type="file" id="csvFile" accept=".csv,text/csv" />
      Choose CSV…
    </label>
    <span id="status"></span>
  </div>

  <div id="reportContainer"></div>

  <!-- PapaParse from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <script>
  /************ CONFIG ************/
  const PALETTE = {
    'Four-Seam': '#000000',
    'Sinker':    '#FF69B4',
    'Slider':    '#0000FF',
    'Changeup':  '#00FF00',
    'Curveball': '#FFA500',
    'Cutter':    '#800080',
    'Splitter':  '#00FFFF',
    'undefined': '#888888'
  };
  const excludePlayers = new Set([
    'Corcino, Daniel','Martinez, Jorge','Rivera, Eduardo','Quintana, Franky',
    'Colon, Rabel','Walker, Mason','Tovalin, Osvaldo','Richards, Jairus',
    'Otosaka, Tomo','Berglund, Michael','King, Thomas','Stem, Craig',
    'Firoved, Graham','Boss, Jackson','Kruglewicz, Parker','Lantigua, John'
  ]);

  /************ STATE ************/
  let allRows = [];
  let paList = []; // [{batter,pitcher,inning,half,paIndex,date}]
  // Map<paKey, {meta:{...}, rows:[original rows], pitches:[precomputed for draw], teams:{bat, pit}}>
  const paMap = new Map();

  const batSel = document.getElementById('battingTeam');
  const pitSel = document.getElementById('pitchingTeam');
  const renderBtn = document.getElementById('renderBtn');
  const container = document.getElementById('reportContainer');
  const fileInput = document.getElementById('csvFile');
  const statusEl = document.getElementById('status');

  const setStatus = (t) => statusEl.textContent = t || '';

  /************ HELPERS ************/
  const round1 = (v) => {
    const n = Number(v);
    return Number.isFinite(n) ? n.toFixed(1) : '';
  };
  const paKey = (r) => [r.Batter, r.Pitcher, r.Inning, r['Top/Bottom'], r.PAofInning].join('||');

  /************ CSV LOAD (robust) ************/
  async function loadFromServer(path = 'data.csv') {
    const url = new URL(path, window.location.href).href; // absolute URL
    setStatus('Loading CSV…');
    const res = await fetch(url, { cache: 'no-store' });
    if (!res.ok) throw new Error(`Fetch failed: ${res.status} ${res.statusText}`);
    const text = await res.text();
    setStatus('Parsing…');
    return new Promise((resolve) => {
      Papa.parse(text, {
        header: true,
        worker: true,         // worker parses the text (no worker XHR)
        dynamicTyping: true,
        fastMode: true,
        skipEmptyLines: true,
        complete: ({ data }) => resolve(data)
      });
    });
  }
  function loadFromFile(file) {
    setStatus(`Reading ${file.name}…`);
    return new Promise((resolve) => {
      Papa.parse(file, {
        header: true,
        worker: true,
        dynamicTyping: true,
        fastMode: true,
        skipEmptyLines: true,
        complete: ({ data }) => resolve(data)
      });
    });
  }

  /************ PREPROCESS (keeps your logic) ************/
  function buildPAListAndMap(rows) {
    allRows = rows.filter(r => r && r.Batter && r.Pitcher);
    const keys = new Set();
    paList = [];
    paMap.clear();

    // 1) Build unique PA list exactly like your code (plus exclusions)
    for (const r of allRows) {
      if (excludePlayers.has(r.Batter) || excludePlayers.has(r.Pitcher)) continue;
      const key = paKey(r);
      if (!keys.has(key)) {
        keys.add(key);
        paList.push({
          batter:  r.Batter,
          pitcher: r.Pitcher,
          inning:  r.Inning,
          half:    r['Top/Bottom'],
          paIndex: r.PAofInning,
          date:    r.Date
        });
        // init paMap bucket
        paMap.set(key, {
          meta: { batter: r.Batter, pitcher: r.Pitcher, inning: r.Inning, half: r['Top/Bottom'], paIndex: r.PAofInning, date: r.Date },
          rows: [],
          pitches: [],
          teams: { bat: null, pit: null } // will fill once we see them
        });
      }
    }

    // 2) Attach rows to each PA bucket and precompute draw/table fields (no extra filters)
    for (const r of allRows) {
      if (excludePlayers.has(r.Batter) || excludePlayers.has(r.Pitcher)) continue;
      const key = paKey(r);
      const bucket = paMap.get(key);
      if (!bucket) continue;
      bucket.rows.push(r);

      // Cache a representative team pairing for this PA (first seen)
      if (bucket.teams.bat == null && r.BatterTeam) bucket.teams.bat = r.BatterTeam;
      if (bucket.teams.pit == null && r.PitcherTeam) bucket.teams.pit = r.PitcherTeam;

      // Precompute per-pitch values used by draw/table
      bucket.pitches.push({
        px: Number(r.PlateLocSide),
        py: Number(r.PlateLocHeight),
        type: r.AutoPitchType || 'undefined',
        color: PALETTE[r.AutoPitchType] || PALETTE.undefined,
        speed: round1(r.RelSpeed),
        spin:  round1(r.SpinRate),
        ivb:   round1(r.InducedVertBreak),
        hb:    round1(r.HorzBreak),
        drop:  round1(r.SpeedDrop),
        result: (r.PitchCall === 'InPlay' ? (r.PlayResult || '–') : (r.PitchCall || '–'))
      });
    }

    // 3) Sort paList same as yours
    paList.sort((a, b) => {
      if (a.batter !== b.batter)   return a.batter.localeCompare(b.batter);
      if (a.pitcher !== b.pitcher) return a.pitcher.localeCompare(b.pitcher);
      return (+a.paIndex) - (+b.paIndex);
    });
  }

  function populateTeamSelectors() {
    const batTeams = [...new Set(allRows.map(r => r.BatterTeam).filter(Boolean))].sort();
    const pitTeams = [...new Set(allRows.map(r => r.PitcherTeam).filter(Boolean))].sort();
    batSel.innerHTML = batTeams.map(t => `<option>${t}</option>`).join('') || '<option>-</option>';
    pitSel.innerHTML = pitTeams.map(t => `<option>${t}</option>`).join('') || '<option>-</option>';
  }

  /************ DRAWING ************/
  function drawPA(pa, canvas, tableDiv) {
    // get pre-grouped rows/pitches for this PA
    const key = [pa.batter, pa.pitcher, pa.inning, pa.half, pa.paIndex].join('||');
    const bucket = paMap.get(key);
    if (!bucket) return;

    // fixed internal resolution (avoids layout reads)
    canvas.width = 600;
    canvas.height = 360;

    const ctx = canvas.getContext('2d'),
          zone  = { left: -17/24, right: 17/24, bottom: 1.5, top: 3.5 },
          m     = 20,
          availW= canvas.width  - m*2,
          availH= canvas.height - m*2,
          baseS = Math.min(availW/(zone.right-zone.left),
                           availH/(zone.top-zone.bottom)),
          scale = baseS * 0.7,
          pixW  = (zone.right - zone.left) * scale,
          pixH  = (zone.top   - zone.bottom) * scale,
          ox    = (canvas.width  - pixW) / 2,
          oy    = (canvas.height + pixH) / 2;

    const mapY = y => oy - (y - zone.bottom) * scale;
    const mapX = x => ox + (x - zone.left) * scale;

    // clear & draw zone
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.strokeStyle = 'black';
    ctx.lineWidth   = 2;
    ctx.strokeRect(ox, mapY(zone.top), pixW, pixH);

    // plot & number each pitch (precomputed)
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.font = '12px sans-serif';
    const rad = 8;

    const P = bucket.pitches;
    for (let i=0; i<P.length; i++) {
      const p = P[i];
      if (!Number.isFinite(p.px) || !Number.isFinite(p.py)) continue;
      const x = mapX(p.px), y = mapY(p.py);
      ctx.fillStyle = p.color;
      ctx.beginPath();
      ctx.arc(x, y, rad, 0, 2*Math.PI);
      ctx.fill();

      ctx.fillStyle = '#fff';
      ctx.fillText(i+1, x, y);
    }

    // build table
    let html = `<table><thead>
      <tr>
        <th>#</th><th>Type</th><th>Result</th>
        <th>Speed</th><th>Spin</th><th>IndV</th><th>Horz</th><th>Drop</th>
      </tr>
    </thead><tbody>`;

    for (let i=0; i<P.length; i++) {
      const p = P[i];
      html += `<tr>
        <td>${i+1}</td>
        <td>${p.type || '–'}</td>
        <td>${p.result}</td>
        <td>${p.speed}</td>
        <td>${p.spin}</td>
        <td>${p.ivb}</td>
        <td>${p.hb}</td>
        <td>${p.drop}</td>
      </tr>`;
    }
    html += `</tbody></table>`;
    tableDiv.innerHTML = html;
  }

  /************ RENDER (keeps your team gating) ************/
  function renderReports() {
    const batTeam = batSel.value;
    const pitTeam = pitSel.value;
    if (!batTeam || !pitTeam || batTeam === 'Loading…' || pitTeam === 'Loading…') return;

    container.innerHTML = '';
    setStatus('Rendering…');

    const frag = document.createDocumentFragment();
    let paCount = 0, currentBatter = null, pageDiv = null;

    // chunk to keep UI responsive
    const CHUNK = 12;
    let idx = 0;

    function nextFrame() {
      const end = Math.min(idx + CHUNK, paList.length);
      for (; idx < end; idx++) {
        const pa = paList[idx];
        const key = [pa.batter, pa.pitcher, pa.inning, pa.half, pa.paIndex].join('||');
        const bucket = paMap.get(key);
        if (!bucket) continue;

        // *** EXACT gating like your code ***
        // Only include this PA if there exists at least one row of this PA
        // where BatterTeam == selected batting team AND PitcherTeam == selected pitching team.
        const include = bucket.rows.some(r => r.BatterTeam === batTeam && r.PitcherTeam === pitTeam);
        if (!include) continue;

        // new batter? reset count + insert blank page
        if (pa.batter !== currentBatter) {
          currentBatter = pa.batter;
          paCount = 0;
          if (frag.lastChild) {
            const bp = document.createElement('div');
            bp.className = 'blank-page';
            frag.appendChild(bp);
          }
        }

        // every 4 PAs → new page
        if (paCount % 4 === 0) {
          pageDiv = document.createElement('div');
          pageDiv.className = 'page';
          frag.appendChild(pageDiv);
        }

        // create card
        const card = document.createElement('div');
        card.className = 'pa-card';
        card.innerHTML = `
          <div class="pa-header">
            ${pa.batter} @ ${pa.pitcher}
            (Inning ${pa.inning} ${pa.half}, PA#${pa.paIndex}) ${pa.date || ''}
          </div>
          <canvas></canvas>
          <div class="detail"></div>`;
        pageDiv.appendChild(card);

        // draw zone + table
        drawPA(pa, card.querySelector('canvas'), card.querySelector('.detail'));

        paCount++;
      }

      if (idx < paList.length) {
        requestAnimationFrame(nextFrame);
      } else {
        container.appendChild(frag);
        setStatus('Done.');
      }
    }
    requestAnimationFrame(nextFrame);
  }

  /************ INIT ************/
  renderBtn.addEventListener('click', renderReports);
  fileInput.addEventListener('change', async (e) => {
    const f = e.target.files?.[0];
    if (!f) return;
    try {
      const rows = await loadFromFile(f);
      buildPAListAndMap(rows);
      populateTeamSelectors();
      setStatus(`Loaded ${rows.length} rows from "${f.name}".`);
    } catch (err) {
      console.error(err);
      setStatus('Failed to parse selected file.');
      alert(err.message || err);
    }
  });

  (async function boot() {
    try {
      const rows = await loadFromServer('data.csv');
      buildPAListAndMap(rows);
      populateTeamSelectors();
      setStatus(`Loaded ${rows.length} rows.`);
    } catch (err) {
      console.warn('Server CSV load failed (use file picker).', err);
      setStatus('Tip: Use “Choose CSV…” to load a file.');
    }
  })();
  </script>
</body>
</html>
